<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Reader - Email Label Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1f2937;
            --secondary-color: #4F46E5;
            --accent-color: #06B6D4;
            --danger-color: #EF4444;
            --success-color: #10B981;
            --light-bg: #F9FAFB;
            --border-color: #E5E7EB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-bar-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-button {
            padding: 8px 16px;
            border: none;
            background: var(--secondary-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: #4338CA;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .nav-button.secondary {
            background: var(--accent-color);
        }

        .nav-button.secondary:hover {
            background: #0891B2;
        }

        .login-button {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .content {
            padding: 40px 20px;
            display: none;
        }

        .content.active {
            display: block;
        }

        .login-container {
            text-align: center;
            padding: 60px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .login-container h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-container p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
            border-color: var(--secondary-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-badge {
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .card-content {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .email-link {
            display: block;
            padding: 8px 0;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 13px;
            word-break: break-word;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            padding-left: 8px;
        }

        .email-link:hover {
            color: var(--accent-color);
            border-left-color: var(--accent-color);
        }

        .card-footer {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: var(--secondary-color);
            color: white;
        }

        .btn-view:hover {
            background: #4338CA;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background: #DC2626;
        }

        .form-section {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 6px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }

        .message.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }

        .message.info {
            background: #DBEAFE;
            color: #0C2340;
            border: 1px solid #93C5FD;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .back-button {
            margin-bottom: 20px;
        }

        .email-list {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .email-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .email-item:last-child {
            border-bottom: none;
        }

        .email-item:hover {
            background: white;
            border-radius: 4px;
        }

        .email-subject {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            word-break: break-word;
        }

        .email-link-text {
            font-size: 12px;
            color: var(--secondary-color);
            text-decoration: none;
            word-break: break-all;
        }

        .email-link-text:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .cards-container {
                grid-template-columns: 1fr;
            }

            .nav-bar {
                flex-direction: column;
                gap: 10px;
            }

            .nav-bar-left {
                width: 100%;
                justify-content: center;
            }

            .form-section {
                padding: 20px;
            }

            .content {
                padding: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìß Gmail Reader</h1>
            <p>Organize and manage your Gmail labels effortlessly</p>
        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar" id="navBar">
            <div class="nav-bar-left">
                <button class="nav-button" id="viewLabelsBtn" onclick="showLabels()" style="display:none;">
                    All Labels
                </button>
                <button class="nav-button secondary" id="createLabelBtn" onclick="showCreateForm()" style="display:none;">
                    + Create Label
                </button>
            </div>
            <div id="userInfo"></div>
        </div>

        <!-- Main Content -->
        <div class="content login-container active" id="loginContent">
            <div>
                <h2>Welcome to Gmail Reader</h2>
                <p>Organize your emails with intelligent labels and filters</p>
                <p style="font-size: 13px; color: var(--text-secondary);">Sign in with your Google account to get started</p>
            </div>
            <button class="login-button" id="loginBtn">Sign in with Google</button>
        </div>

        <!-- Dashboard Content -->
        <div class="content" id="dashboardContent">
            <div id="message" class="message"></div>

            <!-- Labels View -->
            <div id="labelsView" style="display: none;">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="labelCount">0</div>
                        <div class="stat-label">Labels Created</div>
                    </div>
                </div>
                <div id="labelsContainer" class="cards-container"></div>
                <div id="emptyLabels" class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                    <h3>No labels yet</h3>
                    <p>Create your first label to get started</p>
                </div>
            </div>

            <!-- Create Label View -->
            <div id="createLabelView" style="display: none;">
                <button class="nav-button" onclick="showLabels()" style="margin-bottom: 20px;">‚Üê Back to Labels</button>
                <div class="form-section">
                    <h3>Create New Label</h3>
                    <form id="labelForm" onsubmit="createLabel(event)">
                        <div class="form-group">
                            <label for="labelName">Label Name *</label>
                            <input type="text" id="labelName" placeholder="e.g., Work, Important, Newsletters" required>
                            <small>Give your label a descriptive name</small>
                        </div>
                        <div class="form-group">
                            <label for="fromList">Email Addresses (one per line) *</label>
                            <textarea id="fromList" placeholder="Enter email addresses to filter&#10;Example:&#10;sender@example.com&#10;boss@company.com&#10;newsletter@site.com" required></textarea>
                            <small>All emails from these senders will be automatically labeled</small>
                        </div>
                        <button type="submit" class="btn-submit">Create Label</button>
                    </form>
                </div>
            </div>

            <!-- Email View -->
            <div id="emailView" style="display: none;">
                <button class="nav-button" onclick="showLabels()" style="margin-bottom: 20px;">‚Üê Back to Labels</button>
                <h2 id="emailViewTitle" style="margin-bottom: 20px;"></h2>
                <div id="emailContainer"></div>
                <div id="emptyEmails" class="empty-state" style="display: none;">
                    <p>No emails found in this label</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in (after OAuth callback)
        function checkLoginStatus() {
            // After successful OAuth, the server redirects here
            // We can check if there's anything in sessionStorage or we can try to fetch labels
            fetchLabels().then(labels => {
                if (labels !== null) {
                    showDashboard();
                }
            }).catch(() => {
                // User not logged in
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                // Note: Replace with your actual login URL endpoint
                loginBtn.addEventListener('click', function() {
                    // This should redirect to the server's OAuth URL
                    // The server logs the auth URL to console
                    alert('Please check the server console for the login URL and open it in your browser.\n\nThe login URL has been logged to the server console (server.js output).');
                });
            }
        });

        // Message display utility
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message show ${type}`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginContent').classList.remove('active');
            document.getElementById('dashboardContent').classList.add('active');
            document.getElementById('viewLabelsBtn').style.display = 'block';
            document.getElementById('createLabelBtn').style.display = 'block';
            showLabels();
        }

        // Show labels view
        function showLabels() {
            document.getElementById('labelsView').style.display = 'block';
            document.getElementById('createLabelView').style.display = 'none';
            document.getElementById('emailView').style.display = 'none';
            loadLabels();
        }

        // Show create form
        function showCreateForm() {
            document.getElementById('labelsView').style.display = 'none';
            document.getElementById('createLabelView').style.display = 'block';
            document.getElementById('emailView').style.display = 'none';
            document.getElementById('labelForm').reset();
        }

        // Show email view
        function showEmails(labelName) {
            document.getElementById('labelsView').style.display = 'none';
            document.getElementById('createLabelView').style.display = 'none';
            document.getElementById('emailView').style.display = 'block';
            document.getElementById('emailViewTitle').textContent = `Emails - ${labelName}`;
            loadEmails(labelName);
        }

        // Fetch all labels from backend
        async function fetchLabels() {
            try {
                const response = await fetch('/api/labels');
                if (!response.ok) {
                    if (response.status === 404) return null;
                    throw new Error('Failed to fetch labels');
                }
                const data = await response.json();
                return data.data || [];
            } catch (error) {
                console.error('Error fetching labels:', error);
                return [];
            }
        }

        // Load and display labels
        async function loadLabels() {
            const container = document.getElementById('labelsContainer');
            const emptyState = document.getElementById('emptyLabels');
            const labelCount = document.getElementById('labelCount');
            
            container.innerHTML = '<div class="loading" style="margin: 40px auto;"></div>';
            emptyState.style.display = 'none';

            try {
                const labels = await fetchLabels();
                
                if (labels && labels.length > 0) {
                    labelCount.textContent = labels.length;
                    container.innerHTML = labels.map((label, index) => `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">${escapeHtml(label)}</div>
                                <span class="card-badge">Label</span>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-view" onclick="showEmails('${escapeHtml(label)}')">
                                    View Emails
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    labelCount.textContent = '0';
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                showMessage('Error loading labels: ' + error.message, 'error');
                container.innerHTML = '';
                emptyState.style.display = 'block';
            }
        }

        // Load and display emails for a label
        async function loadEmails(labelName) {
            const container = document.getElementById('emailContainer');
            const emptyState = document.getElementById('emptyEmails');
            
            container.innerHTML = '<div class="loading" style="margin: 40px auto;"></div>';
            emptyState.style.display = 'none';

            try {
                const response = await fetch(`/api/emails?labelName=${encodeURIComponent(labelName)}`);
                if (!response.ok) throw new Error('Failed to fetch emails');
                
                const data = await response.json();
                const emails = data.data || {};
                
                const emailArray = Object.entries(emails);
                
                if (emailArray.length > 0) {
                    container.innerHTML = `
                        <div class="email-list">
                            ${emailArray.map(([subject, link]) => `
                                <div class="email-item">
                                    <div class="email-subject">${escapeHtml(subject)}</div>
                                    <a href="${link}" target="_blank" class="email-link-text">Open in Gmail ‚Üí</a>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                showMessage('Error loading emails: ' + error.message, 'error');
                container.innerHTML = '';
                emptyState.style.display = 'block';
            }
        }

        // Create a new label
        async function createLabel(event) {
            event.preventDefault();
            
            const labelName = document.getElementById('labelName').value.trim();
            const fromListText = document.getElementById('fromList').value.trim();
            
            if (!labelName || !fromListText) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            const fromList = fromListText
                .split('\n')
                .map(email => email.trim())
                .filter(email => email.length > 0);
            
            if (fromList.length === 0) {
                showMessage('Please enter at least one email address', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            for (const email of fromList) {
                if (!emailRegex.test(email)) {
                    showMessage(`Invalid email format: ${email}`, 'error');
                    return;
                }
            }
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span>';
            
            try {
                const response = await fetch('/api/create-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        labelName,
                        fromList
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create label');
                }
                
                showMessage(`Label "${labelName}" created successfully!`, 'success');
                document.getElementById('labelForm').reset();
                setTimeout(() => showLabels(), 1500);
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Utility: Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
